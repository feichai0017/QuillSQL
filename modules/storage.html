<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Storage Engine - QuillSQL Internals</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">QuillSQL Internals</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="storage-engine"><a class="header" href="#storage-engine">Storage Engine</a></h1>
<p>The storage engine is the foundational layer of QuillSQL, responsible for managing how data is physically stored, retrieved, and organized on disk. It acts as the bridge between the in-memory buffer pool and the on-disk database files. Its primary goal is to provide a reliable and efficient abstraction for higher-level components, like the execution engine and transaction manager, to work with data without needing to understand the intricacies of file I/O.</p>
<h2 id="core-components"><a class="header" href="#core-components">Core Components</a></h2>
<p>The storage engine is built around a few key abstractions:</p>
<ul>
<li><strong><code>DiskManager</code></strong>: The lowest-level component that directly reads and writes raw bytes from the database file in fixed-size blocks called pages.</li>
<li><strong><code>TableHeap</code></strong>: Represents the collection of pages that hold the actual data for a single table. It manages the layout of tuples within these pages.</li>
<li><strong><code>Tuple</code></strong>: The internal representation of a single row of data, containing the values for each column.</li>
</ul>
<hr />
<h2 id="tuple-storagetuplers"><a class="header" href="#tuple-storagetuplers">Tuple (<code>storage/tuple.rs</code>)</a></h2>
<p>A <code>Tuple</code> is the most basic unit of data, representing a single record or row.</p>
<h3 id="structure"><a class="header" href="#structure">Structure</a></h3>
<ul>
<li><strong><code>data: Vec&lt;ScalarValue&gt;</code></strong>: A vector where each element is a <code>ScalarValue</code>, an enum that can hold any of the database's supported data types (e.g., <code>Int32</code>, <code>Varchar</code>, <code>Bool</code>).</li>
<li><strong><code>schema: SchemaRef</code></strong>: A shared reference (<code>Arc&lt;Schema&gt;</code>) to the tuple's schema. The schema describes the name and data type of each column, allowing the database to correctly interpret the <code>data</code> vector.</li>
</ul>
<h3 id="key-functionality"><a class="header" href="#key-functionality">Key Functionality</a></h3>
<ul>
<li><strong>Creation &amp; Merging</strong>: Provides methods to create new tuples from a vector of values and to merge multiple tuples horizontally, which is essential for implementing database joins.</li>
<li><strong>Projections</strong>: Can create a new, smaller tuple containing only a subset of its original columns based on a target schema.</li>
<li><strong>Comparison</strong>: Implements <code>Ord</code> and <code>PartialOrd</code>, allowing tuples to be compared against each other. This is critical for sorting data and for evaluating filter conditions in <code>WHERE</code> clauses.</li>
</ul>
<hr />
<h2 id="disk-manager-storagedisk_managerrs"><a class="header" href="#disk-manager-storagedisk_managerrs">Disk Manager (<code>storage/disk_manager.rs</code>)</a></h2>
<p>The <code>DiskManager</code> is the exclusive interface to the physical database file on disk. It abstracts file I/O into page-oriented operations, hiding details like file handles and offsets.</p>
<h3 id="responsibilities"><a class="header" href="#responsibilities">Responsibilities</a></h3>
<ul>
<li><strong>Page I/O</strong>: Its core responsibility is to provide <code>read_page(page_id)</code> and <code>write_page(page_id, data)</code> methods. It translates a logical <code>PageId</code> into a specific byte offset in the database file.</li>
<li><strong>Page Allocation</strong>: When a new page is needed, the <code>DiskManager</code> allocates space for it in the database file by incrementing an atomic <code>next_page_id</code> counter.</li>
<li><strong>Freelist Management</strong>: To avoid letting the database file grow indefinitely, the <code>DiskManager</code> maintains a freelist of pages that have been deallocated. When a new page is requested, it first attempts to retrieve one from the freelist before allocating a new one.</li>
<li><strong>Meta Page</strong>: It manages a special <code>MetaPage</code> at the beginning of the database file (offset 0). This page stores critical database-wide metadata, such as the <code>PageId</code> of the first page in the freelist chain.</li>
</ul>
<h3 id="direct-io"><a class="header" href="#direct-io">Direct I/O</a></h3>
<p>A key feature of the <code>DiskManager</code> is its attempt to use <strong>Direct I/O</strong> (<code>O_DIRECT</code> on Linux).</p>
<ul>
<li><strong>Bypassing OS Cache</strong>: Direct I/O allows the database to bypass the operating system's page cache and write directly to the disk hardware. This prevents a "double caching" problem where data exists once in the database's own buffer pool and again in the OS cache. Giving the database exclusive control over caching is crucial for predictable performance and implementing its own buffer replacement policies (like LRU-K).</li>
<li><strong>Alignment</strong>: Direct I/O imposes strict memory alignment requirements. The <code>DiskManager</code> handles this by using a special <code>AlignedPageBuf</code> to ensure that all data buffers passed to the OS for reading or writing are aligned to the page size boundary.</li>
<li><strong>Fallback</strong>: If Direct I/O is not supported by the filesystem, the <code>DiskManager</code> gracefully falls back to standard, buffered I/O.</li>
</ul>
<hr />
<h2 id="table-heap-storagetable_heaprs"><a class="header" href="#table-heap-storagetable_heaprs">Table Heap (<code>storage/table_heap.rs</code>)</a></h2>
<p>A <code>TableHeap</code> organizes the set of pages that belong to a single table. It's called a "heap" because tuples are not stored in any specific order within the pages; they are simply appended as they come.</p>
<h3 id="structure--page-management"><a class="header" href="#structure--page-management">Structure &amp; Page Management</a></h3>
<ul>
<li>A <code>TableHeap</code> doesn't own the pages themselves but manages their <code>PageId</code>s. It keeps track of the <code>first_page_id</code> and <code>last_page_id</code> to maintain a linked list of pages for the table.</li>
<li>It interacts with the <code>BufferManager</code> to fetch pages into memory for reading or modification. It does <strong>not</strong> call the <code>DiskManager</code> directly.</li>
</ul>
<h3 id="tuple--version-management"><a class="header" href="#tuple--version-management">Tuple &amp; Version Management</a></h3>
<ul>
<li><strong>Insertion (<code>insert_tuple</code>)</strong>: When a new tuple is inserted, the <code>TableHeap</code> fetches the last page of the table. If there is enough free space, the tuple is inserted there. If the page is full, it requests a completely new page from the buffer pool, links it to the end of the page list, and inserts the tuple there.</li>
<li><strong>MVCC Support</strong>: The <code>TableHeap</code> is central to QuillSQL's Multi-Version Concurrency Control (MVCC) strategy.
<ul>
<li>An <code>UPDATE</code> operation does not modify a tuple in-place. Instead, it calls <code>mvcc_update</code>, which creates a <strong>new version</strong> of the tuple (often in a different location) and uses transaction metadata to link the old and new versions together in a version chain.</li>
<li>A <code>DELETE</code> operation simply marks a tuple version as deleted by updating its metadata; it doesn't immediately remove the data.</li>
</ul>
</li>
<li><strong>Iteration</strong>: It provides a <code>TableIterator</code> that allows the execution engine to perform a sequential scan over every tuple in the table. The iterator traverses the linked list of pages and iterates over the tuples within each page.</li>
</ul>
<h3 id="integration-with-write-ahead-logging-wal"><a class="header" href="#integration-with-write-ahead-logging-wal">Integration with Write-Ahead Logging (WAL)</a></h3>
<ul>
<li>The <code>TableHeap</code> is a key participant in ensuring data durability. Before it modifies a page (e.g., by inserting a tuple), it first generates a corresponding WAL record (e.g., <code>HeapInsertPayload</code>).</li>
<li>This record is passed to the <code>WalManager</code>, which writes it to the log. Only after the log record is secured can the actual page in the buffer pool be modified. This "log first" rule ensures that if the system crashes, the recovery process can replay the WAL to restore all committed changes.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../btree_index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../modules/buffer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../btree_index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../modules/buffer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
