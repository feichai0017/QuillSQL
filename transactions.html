<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transactions &amp; Concurrency - QuillSQL Internals</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">QuillSQL Internals</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="transactions-concurrency--mvcc"><a class="header" href="#transactions-concurrency--mvcc">Transactions, Concurrency &amp; MVCC</a></h1>
<p>This guide dives into QuillSQL’s transaction subsystem, how MVCC snapshots are produced and consumed, and the supporting background processes that keep old versions in check. Diagrams are provided using Mermaid for easy rendering.</p>
<hr />
<h2 id="1-module-overview"><a class="header" href="#1-module-overview">1. Module Overview</a></h2>
<pre><code class="language-mermaid">flowchart LR
    Session["SessionContext"] --&gt; TM["TransactionManager"]
    TM --&gt; LM["LockManager"]
    TM --&gt; WAL["WalManager"]
    TM --&gt; Snap["TransactionSnapshot"]
    TM --&gt; Undo["Undo stack"]
    LM --&gt;|table/row locks| Storage["TableHeap / Index"]
    Snap --&gt; Runtime["TxnRuntime"]
    Runtime --&gt; Exec["Physical operators"]
</code></pre>
<ul>
<li>
<p><strong><code>SessionContext</code> (<code>src/session/mod.rs</code>)</strong><br />
Manages per-connection defaults (isolation, access mode, autocommit) and the active <code>Transaction</code>. Handles <code>SET TRANSACTION</code>/<code>SET SESSION TRANSACTION</code>, ensuring new transactions inherit the desired modes.</p>
</li>
<li>
<p><strong><code>Transaction</code> (<code>src/transaction/transaction.rs</code>)</strong><br />
Stores the transaction id, isolation/access mode, state, WAL LSNs, undo actions, command counters, and—starting with this release—a cached MVCC snapshot used for Repeatable Read / Serializable.</p>
</li>
<li>
<p><strong><code>TransactionManager</code></strong><br />
Entry point for <code>begin</code>, <code>commit</code>, and <code>abort</code>. Assigns IDs, writes WAL begin/commit/abort records, maintains active transaction sets, and provides helper methods for acquiring table/row locks. Produces <code>TransactionSnapshot</code> objects that encode <code>xmin</code>, <code>xmax</code>, and the active transaction list for visibility decisions.</p>
</li>
<li>
<p><strong><code>TxnRuntime</code> (<code>src/transaction/runtime.rs</code>)</strong><br />
Lightweight wrapper handed to physical operators. Each command increments the transaction’s command id, selects (or reuses) the appropriate snapshot based on isolation level, and exposes helpers for row/table locks plus visibility checks.</p>
</li>
<li>
<p><strong><code>LockManager</code></strong><br />
Central 2PL engine with multi-granularity modes (IS/IX/S/SIX/X), FIFO wait queues, and deadlock detection via a wait-for graph. Shared row locks are released eagerly for RC, retained within the command for RR, and held to commit for Serializable.</p>
</li>
<li>
<p><strong>Undo Stack</strong><br />
DML operators push logical undo entries so abort/rollback can restore heap pages and remove secondary index entries. Abort writes CLRs and replays undo actions.</p>
</li>
<li>
<p><strong>Background MVCC Vacuum</strong><br />
<code>background::spawn_mvcc_vacuum_worker</code> computes <code>safe_xmin</code> from the transaction manager’s oldest active id and reclaims tuple versions deleted by committed transactions or inserted by aborted ones once no running transaction can see them.</p>
</li>
</ul>
<hr />
<h2 id="2-snapshot-semantics"><a class="header" href="#2-snapshot-semantics">2. Snapshot Semantics</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Isolation Level</th><th>Snapshot Lifetime</th><th>Lock Behavior</th><th>Notes</th></tr></thead><tbody>
<tr><td>Read Uncommitted</td><td>Fresh snapshot per command</td><td>No shared row locks</td><td>May see dirty reads; used mainly for diagnostics.</td></tr>
<tr><td>Read Committed</td><td>Fresh snapshot per command</td><td>Shared locks acquired then released immediately</td><td>Prevents dirty reads; each statement sees the latest committed data.</td></tr>
<tr><td>Repeatable Read</td><td>Snapshot cached at first command and reused</td><td>Shared locks kept for the duration of the command, then released</td><td>Provides statement-consistent reads. MVCC ensures previously read rows remain stable across statements.</td></tr>
<tr><td>Serializable</td><td>Same cached snapshot as RR</td><td>Shared locks retained until commit (strict 2PL)</td><td>Today equivalent to locking-based serializable. Future work: SSI / predicate locking.</td></tr>
</tbody></table>
</div>
<ul>
<li><code>Transaction::set_snapshot</code> caches the snapshot for RR/SR; <code>clear_snapshot</code> is invoked when the isolation level drops to RC/RU or at commit/abort.</li>
<li><code>TransactionSnapshot::is_visible</code> inspects tuple metadata (<code>insert_txn_id</code>, <code>delete_txn_id</code>, <code>CommandId</code>) to decide whether the tuple should be visible for the current command, accounting for aborted transactions, active transactions, and self-modifications.</li>
</ul>
<hr />
<h2 id="3-statement-execution-timeline"><a class="header" href="#3-statement-execution-timeline">3. Statement Execution Timeline</a></h2>
<pre><code class="language-mermaid">sequenceDiagram
    participant Client
    participant Session
    participant Exec as Executor
    participant Runtime as TxnRuntime
    participant Heap as TableHeap
    participant TM as TransactionManager

    Client-&gt;&gt;Session: "BEGIN ISOLATION LEVEL REPEATABLE READ"
    Session-&gt;&gt;TM: begin(RR, ReadWrite)
    TM--&gt;&gt;Session: Transaction { snapshot: None }
    Client-&gt;&gt;Session: "SELECT * FROM accounts"
    Session-&gt;&gt;Exec: plan + txn
    Exec-&gt;&gt;Runtime: TxnRuntime::new(&amp;TM, &amp;mut txn)
    Runtime--&gt;&gt;Exec: snapshot S0, command_id 0
    Exec-&gt;&gt;Heap: SeqScan (S locks retained for this command)
    Heap--&gt;&gt;Exec: (rid, meta, tuple)
    Exec-&gt;&gt;Runtime: is_visible(meta)?
    Runtime--&gt;&gt;Exec: decision based on S0
    Client-&gt;&gt;Session: "UPDATE accounts SET balance=... WHERE id=1"
    Exec-&gt;&gt;Runtime: TxnRuntime::new(&amp;TM, &amp;mut txn)
    Runtime--&gt;&gt;Exec: reuse snapshot S0, command_id 1
    Exec-&gt;&gt;Heap: mvcc_update + exclusive lock
    Exec-&gt;&gt;TM: register undo + WAL
    Client-&gt;&gt;Session: "COMMIT"
    Session-&gt;&gt;TM: commit(&amp;mut txn)
    TM-&gt;&gt;WAL: Transaction(Commit)
    TM--&gt;&gt;Session: release locks, clear snapshot
</code></pre>
<p>Key behaviors:</p>
<ul>
<li>UPDATE skips tuple versions created by the same <code>(txn_id, command_id)</code> to avoid chasing its own MVCC chain.</li>
<li>If another transaction commits in between the two statements, its new version remains invisible to the RR transaction thanks to the cached snapshot.</li>
<li>Shared locks used to verify visibility are released at the end of each command in RR, while Serializable holds them longer to ensure strict 2PL.</li>
</ul>
<hr />
<h2 id="4-background-mvcc-vacuum"><a class="header" href="#4-background-mvcc-vacuum">4. Background MVCC Vacuum</a></h2>
<pre><code class="language-mermaid">flowchart TD
    TM["TransactionManager"] --&gt;|oldest_active_txn| Vacuum
    Vacuum["background::mvcc_vacuum_worker"] --&gt;|safe_xmin| Compact
    Compact["vacuum_table_versions"] --&gt; Table["TableHeap"]
</code></pre>
<p>Algorithm sketch:</p>
<ol>
<li>Compute <code>safe_xmin = oldest_active_txn() or next_txn_id_hint()</code>.</li>
<li>For each registered table (excluding information_schema), iterate tuples in batches.</li>
<li>If a tuple is marked deleted and <code>delete_txn_id &lt; safe_xmin</code>, reclaim it.</li>
<li>If a tuple was inserted by an aborted txn with <code>insert_txn_id &lt; safe_xmin</code>, reclaim it.</li>
<li>Stop after <code>batch_limit</code> tuples per run.</li>
</ol>
<p>This keeps heap pages compact over time without blocking foreground work.</p>
<hr />
<h2 id="5-integration-with-wal--recovery"><a class="header" href="#5-integration-with-wal--recovery">5. Integration with WAL &amp; Recovery</a></h2>
<ul>
<li><code>TransactionManager::begin/commit/abort</code> append WAL records. Commit optionally waits for durability based on <code>synchronous_commit</code>.</li>
<li>Aborts walk the undo stack, emit CLRs, and replay inverse heap/index changes.</li>
<li>Recovery follows ARIES (analysis → redo → undo). CLRs make undo idempotent in case a crash happens during recovery.</li>
<li>Buffer manager tracks dirty pages and recLSNs; checkpoints capture the ATT + DPT so redo can start near the earliest outstanding change.</li>
</ul>
<hr />
<h2 id="6-testing--diagnostics"><a class="header" href="#6-testing--diagnostics">6. Testing &amp; Diagnostics</a></h2>
<ul>
<li>Unit tests in <code>src/tests/transaction_tests.rs</code> cover:
<ul>
<li>Read-only enforcement (<code>read_only_transaction_rejects_dml</code>).</li>
<li>Read Committed self-update (<code>read_committed_allows_update_after_select</code>).</li>
<li>Lock blocking (<code>repeatable_read_blocks_update_until_commit</code>).</li>
<li>Snapshot isolation (<code>repeatable_read_sees_consistent_snapshot_after_update</code>).</li>
</ul>
</li>
<li>Use <code>RUST_LOG=trace</code> to surface lock grants, wait edges, and deadlock warnings.</li>
<li><code>TransactionManager::active_transactions()</code> and <code>oldest_active_txn()</code> help debugging vacuum decisions.</li>
</ul>
<hr />
<h2 id="7-future-work"><a class="header" href="#7-future-work">7. Future Work</a></h2>
<ul>
<li>Predicate / next-key locking to prevent phantoms under Serializable.</li>
<li>Expose transaction statistics (wait time, undo size) via system tables.</li>
<li>Smarter vacuum scheduling based on table size and churn.</li>
<li>Serializable Snapshot Isolation (SSI) to reduce locking while ensuring serializability.</li>
</ul>
<p>The current system already mirrors industrial designs: MVCC + 2PL, ARIES-style WAL, cached snapshots for higher isolation levels, and background vacuuming. These docs should help both contributors and students trace how a transaction traverses the stack and where to hook in new behavior.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="wal.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="btree_index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="wal.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="btree_index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
