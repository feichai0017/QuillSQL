<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuillSQL Console</title>
    <style>
      :root {
        --bg: #0b0f19; --panel: #111826; --panel-dark: #0e1422; --border: #1f2937; --text: #cbd5e1; --text-bright: #e2e8f0;
        --muted: #8b9bb3; --accent: #00e5ff; --accent-hover: #00c4e6; --success: #22d3ee; --warning: #f59e0b; --error: #ef4444;
        --sql-keyword: #60a5fa; --sql-string: #f472b6; --sql-comment: #34d399; --grid: rgba(148,163,184,0.08);
      }
      * { box-sizing: border-box; }
      body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; position: relative; }
      body::before {
        content: ""; position: absolute; inset: 0; pointer-events: none; opacity: 0.65;
        background:
          linear-gradient(180deg, rgba(0,229,255,0.06), transparent 25%, transparent 75%, rgba(0,229,255,0.04)) ,
          radial-gradient(800px 400px at 10% -10%, rgba(0,229,255,0.12), transparent 60%),
          radial-gradient(800px 400px at 110% 110%, rgba(168,85,247,0.10), transparent 60%),
          repeating-linear-gradient(0deg, transparent, transparent 22px, var(--grid) 23px),
          repeating-linear-gradient(90deg, transparent, transparent 22px, var(--grid) 23px);
        mask-image: radial-gradient(1200px 600px at 50% -20%, black 30%, transparent 70%);
      }
      body::after {
        content: ""; position: absolute; inset: 0; pointer-events: none;
        background: radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,0.25), transparent 60%);
      }
      .layout { display: flex; flex-direction: column; height: 100vh; }

      /* Header */
      .header { background: rgba(14,20,34,0.8); backdrop-filter: blur(6px); border-bottom: 1px solid var(--border); padding: 10px 14px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; box-shadow: inset 0 -1px 0 rgba(255,255,255,0.04); }
      .header img { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; }
      .header .brand { font-size: 14px; font-weight: 700; color: var(--text-bright); letter-spacing: 0.3px; }
      .header .spacer { flex: 1; }
      .header a { color: var(--text-bright); text-decoration: none; font-size: 12px; margin-left: 10px; padding: 6px 10px; border: 1px solid rgba(0,229,255,0.18); border-radius: 999px; background: linear-gradient(180deg, rgba(0,229,255,0.08), rgba(0,229,255,0.04)); box-shadow: 0 0 0 1px rgba(0,229,255,0.06) inset; transition: all .15s ease; }
      .header a:hover { color: var(--text-bright); border-color: rgba(0,229,255,0.35); box-shadow: 0 0 16px rgba(0,229,255,0.12), 0 0 0 1px rgba(0,229,255,0.12) inset; }

      /* Main */
      .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
      .query-panel { background: rgba(17,24,38,0.8); border-bottom: 1px solid var(--border); padding: 12px; flex-shrink: 0; }
      .query-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; color: var(--muted); }
      .query-header .status { margin-left: auto; }
      .sql-editor { width: 100%; height: 120px; background: #0f172a; border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px; font-size: 13px; resize: vertical; box-shadow: 0 4px 20px rgba(0,0,0,0.25) inset; }
      .controls { display: flex; gap: 6px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
      button { padding: 6px 12px; background: var(--accent); color: var(--text-bright); border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
      button:hover { background: var(--accent-hover); }
      button.secondary { background: var(--panel-dark); border: 1px solid var(--border); }
      button.secondary:hover { background: var(--border); }
      select, input[type="text"] { background: #1b1b1b; border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 4px 6px; font-size: 12px; }

      /* Results */
      .results-panel { flex: 1; display: flex; flex-direction: column; background: rgba(17,24,38,0.8); }
      .results-header { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); background: rgba(14,20,34,0.8); }
      .results-content { flex: 1; overflow: auto; padding: 12px; }
      table { border-collapse: collapse; width: 100%; font-size: 12px; background: #0b1224; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
      th { background: #0d1326; color: var(--text-bright); font-weight: 600; text-align: left; padding: 8px; border: 1px solid var(--border); }
      td { padding: 6px 8px; border: 1px solid var(--border); color: var(--text); }
      tr:nth-child(even) { background: rgba(255,255,255,0.03); }
      tr:hover { background: rgba(255,255,255,0.05); }
      .result-block { margin-bottom: 14px; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
      .stmt { padding: 6px 8px; font-size: 11px; color: var(--sql-keyword); background: #101116; border-bottom: 1px solid var(--border); }
      .rows-info { font-size: 11px; color: var(--muted); padding: 6px 8px; border-top: 1px solid var(--border); background: #101116; }
      .error { color: var(--text-bright); background: #2b1a1a; border-left: 3px solid var(--error); padding: 10px; white-space: pre-wrap; font-size: 12px; }
      .success { color: var(--success); font-size: 12px; }
      .empty-state { text-align: center; color: var(--muted); font-size: 12px; padding: 40px; }

      /* Footer */
      .footer { background: rgba(14,20,34,0.8); backdrop-filter: blur(6px); border-top: 1px solid var(--border); padding: 6px 12px; font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
      .footer .config { display: flex; align-items: center; gap: 6px; }
      .footer input { width: 320px; background: #0f172a; border: 1px solid var(--border); color: var(--text); border-radius: 6px; }

      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
  </head>
  <body>
    <div class="layout">
      <div class="header">
        <img src="/rust-db.png" alt="logo" />
        <div class="brand">QuillSQL Console</div>
        <div class="spacer"></div>
        <a href="/docs.html?file=buffer_pool.md" target="_blank">Buffer Pool</a>
        <a href="/docs.html?file=btree_index.md" target="_blank">B+Tree</a>
        <a href="/docs.html?file=disk_io.md" target="_blank">Disk I/O</a>
        <a href="https://github.com/feichai0017/quillsql" target="_blank">GitHub</a>
      </div>

      <div class="main">
        <div class="query-panel">
          <div class="query-header">
            SQL Query Editor
            <span class="status" id="status"></span>
          </div>
          <textarea id="sql" class="sql-editor" placeholder="-- 仅展示已实现的语法：INT/BOOLEAN/VARCHAR、SELECT/INSERT/UPDATE、INNER/CROSS JOIN、COUNT/AVG、ORDER BY、LIMIT/OFFSET、信息模式查询"></textarea>
          <div class="controls">
            <button id="run">▶ Execute (Ctrl+Enter)</button>
            <select id="exampleSel">
              <option value="">Choose Example...</option>
              <option value="basic">Basic Operations</option>
              <option value="index">Index Usage</option>
              <option value="join">Joins & Aggregates</option>
              <option value="update">Updates</option>
              <option value="schema">Schema Info</option>
            </select>
            <button id="applyExample" class="secondary">Load Example</button>
            <button id="clear" class="secondary">Clear Results</button>
            <button id="format" class="secondary">Format SQL</button>
          </div>
        </div>

        <div class="results-panel">
          <div class="results-header">Query Results</div>
          <div class="results-content">
            <div id="result" class="empty-state">Execute a query to see results here</div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="config">
          <label>API Endpoint:</label>
          <input id="apiBase" type="text" placeholder="/api/sql or https://quillsql.fly.dev/api/sql" />
          <button id="saveApiBase" class="secondary">Save</button>
        </div>
        <span>QuillSQL v0.1.0 | Persistent storage via QUILL_DB_FILE</span>
      </div>
    </div>

    <script>
      const runBtn = document.getElementById('run');
      const exampleSel = document.getElementById('exampleSel');
      const applyExample = document.getElementById('applyExample');
      const clearBtn = document.getElementById('clear');
      const formatBtn = document.getElementById('format');
      const sqlTA = document.getElementById('sql');
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const apiBaseInput = document.getElementById('apiBase');
      const saveApiBaseBtn = document.getElementById('saveApiBase');

      const defaultApi = '/api/sql';
      const getApiBase = () => (localStorage.getItem('apiBase') || defaultApi);
      const setApiBase = (v) => localStorage.setItem('apiBase', v);
      apiBaseInput.value = getApiBase();

      function renderTable(rows) {
        const cols = Math.max(...rows.map(r => r.length));
        const th = Array.from({length: cols}, (_, i) => `<th>Column ${i+1}</th>`).join('');
        const trs = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
      }

      function renderResult(rows) {
        if (!rows || rows.length === 0) {
          return '<div class="success">✓ Query executed successfully (0 rows)</div>';
        }
        const singleCol = rows.every(r => r.length === 1);
        if (singleCol) {
          const text = rows.map(r => r[0]).join('\n');
          return `<pre style="background:#0f1117;border:1px solid var(--border);padding:10px;border-radius:6px;white-space:pre-wrap;">${text.replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</pre>`;
        }
        return renderTable(rows);
      }

      function friendlyError(text) {
        const t = String(text || '');
        if (/Not\s*support|not\s*supported|NotSupport/i.test(t)) {
          return `不支持的语句或数据类型\n\n${t}`;
        }
        return t;
      }

      async function runSQL() {
        status.textContent = '⏳ Executing...';
        result.innerHTML = '';
        try {
          const api = getApiBase();
          const statements = sqlTA.value
            .split(';')
            .map(s => s.trim())
            .filter(s => s.length > 0)
            .slice(0, 100);

          if (statements.length === 0) {
            result.innerHTML = '<div class="empty-state">No SQL statements to execute</div>';
            return;
          }

          let out = '';

          // Prefer batch API if available, fallback to per-statement
          const batchApi = api.replace(/\/sql$/, '/sql_batch');
          let usedBatch = false;
          try {
            const bres = await fetch(batchApi, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sql: sqlTA.value }) });
            if (bres.ok) {
              const data = await bres.json();
              const results = Array.isArray(data.results) ? data.results : [];
              for (let i = 0; i < Math.min(results.length, statements.length); i++) {
                const rows = results[i] || [];
                const body = rows.length ? renderResult(rows) : '<div class="success">✓ Query executed successfully (0 rows)</div>';
                out += `<div class="result-block"><div class="stmt">Statement ${i+1}: ${statements[i]}</div>${body}<div class="rows-info">${rows.length} rows</div></div>`;
              }
              usedBatch = true;
            }
          } catch (_) { /* ignore and fallback */ }

          if (!usedBatch) {
            for (const [i, stmt] of statements.entries()) {
              const res = await fetch(api, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sql: stmt }) });
              if (!res.ok) {
                const err = await res.text();
                out += `<div class="result-block"><div class="stmt">Statement ${i+1}: ${stmt}</div><div class="error">❌ ${friendlyError(err)}</div></div>`;
                break;
              } else {
                const data = await res.json();
                const rows = data.rows || [];
                const body = rows.length ? renderResult(rows) : '<div class="success">✓ Query executed successfully (0 rows)</div>';
                out += `<div class="result-block"><div class="stmt">Statement ${i+1}: ${stmt}</div>${body}<div class="rows-info">${rows.length} rows</div></div>`;
              }
            }
          }

          result.innerHTML = out || '<div class="success">✓ All queries completed</div>';
        } catch (e) {
          result.innerHTML = `<div class="error">❌ Connection Error: ${e}</div>`;
        } finally {
          status.textContent = '✓ Ready';
        }
      }

      runBtn.addEventListener('click', runSQL);
      sqlTA.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) runSQL(); });
      clearBtn.addEventListener('click', () => { result.innerHTML = '<div class="empty-state">Execute a query to see results here</div>'; });
      formatBtn.addEventListener('click', () => {
        const formatted = sqlTA.value
          .replace(/\s+/g, ' ')
          .replace(/\s*;\s*/g, ';\n')
          .replace(/\b(SELECT|FROM|WHERE|ORDER BY|GROUP BY|HAVING|INSERT|UPDATE|DELETE|CREATE|EXPLAIN|LIMIT|OFFSET|INNER JOIN|CROSS JOIN|SHOW TABLES|SHOW DATABASES)\b/gi, '\n$1')
          .replace(/^\s+/gm, '')
          .trim();
        sqlTA.value = formatted;
      });

      applyExample.addEventListener('click', () => {
        const pick = exampleSel.value;
        if (pick === 'basic') {
          sqlTA.value = `-- Basic table operations\nCREATE TABLE users(id INT NOT NULL, name VARCHAR(50), age INT DEFAULT 0);\nINSERT INTO users(id, name, age) VALUES (1, 'Alice', 25), (2, 'Bob', 30), (3, 'Carol', 35);\nSELECT id, name, age FROM users WHERE age > 25 ORDER BY age DESC;`;
        } else if (pick === 'index') {
          sqlTA.value = `-- Index usage\nCREATE TABLE products(id INT NOT NULL, name VARCHAR(100), price INT, category_id INT);\nCREATE INDEX idx_products_category ON products(category_id);\nINSERT INTO products VALUES (1, 'Laptop', 1200, 1), (2, 'Mouse', 25, 1), (3, 'Book', 15, 2);\nSELECT id, name FROM products WHERE category_id = 1;`;
        } else if (pick === 'join') {
          sqlTA.value = `-- Supported joins + aggregates (COUNT/AVG)\nCREATE TABLE customers(id INT, name VARCHAR(50));\nCREATE TABLE orders(id INT, customer_id INT, amount INT);\nINSERT INTO customers VALUES (1, 'Alice'), (2, 'Bob');\nINSERT INTO orders VALUES (101, 1, 100), (102, 1, 200), (103, 2, 150);\nSELECT c.name, COUNT(o.id) AS cnt, AVG(o.amount) AS avg_amount\nFROM customers c INNER JOIN orders o ON c.id = o.customer_id\nGROUP BY c.name ORDER BY c.name;`;
        } else if (pick === 'update') {
          sqlTA.value = `-- Update operations\nCREATE TABLE inventory(id INT, name VARCHAR(50), quantity INT, price INT);\nINSERT INTO inventory VALUES (1, 'Widget A', 100, 10), (2, 'Widget B', 50, 20);\nUPDATE inventory SET price = 11 WHERE id = 1;\nSELECT * FROM inventory ORDER BY id;`;
        } else if (pick === 'schema') {
          sqlTA.value = `-- Information schema\nSHOW DATABASES;\nSHOW TABLES;\nSELECT table_name FROM information_schema.tables ORDER BY table_name LIMIT 10;`;
        }
      });

      saveApiBaseBtn.addEventListener('click', () => {
        const v = apiBaseInput.value.trim();
        if (v) { setApiBase(v); status.textContent = '✓ Endpoint saved'; setTimeout(() => status.textContent = '✓ Ready', 1600); }
      });

      status.textContent = '✓ Ready';
    </script>
  </body>
</html>