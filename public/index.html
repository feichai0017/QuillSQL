<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuillSQL Web Shell</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/jquery.terminal@2.x.x/css/jquery.terminal.min.css" />
  <script src="https://unpkg.com/jquery@3.x.x/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery.terminal@2.x.x/js/jquery.terminal.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/wcwidth.js"></script>
  <style>
    :root {
      --bg: #030609;
      --accent: #7ef7c7;
      --accent-strong: #24f7a0;
      --text: #d4f5ff;
      --muted: #7ea1b8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Source Code Pro', monospace;
      background: radial-gradient(circle at 20% 20%, rgba(36, 247, 160, 0.22), transparent 50%), radial-gradient(circle at 80% 0%, rgba(30, 90, 255, 0.12), transparent 55%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(rgba(126, 247, 199, 0.05) 1px, transparent 1px);
      background-size: 100% 2px;
      opacity: 0.25;
    }

    .hero {
      padding: 36px 20px 12px;
      display: flex;
      justify-content: center;
    }

    .hero-card {
      display: flex;
      gap: 24px;
      align-items: center;
      max-width: 960px;
      width: 100%;
      padding: 24px 28px;
      border: 1px solid rgba(126, 247, 199, 0.24);
      border-radius: 16px;
      background: rgba(2, 9, 14, 0.76);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
    }

    .hero-card img {
      width: 96px;
      height: 96px;
      border-radius: 12px;
      border: 1px solid rgba(126, 247, 199, 0.4);
      padding: 8px;
      background: rgba(7, 19, 24, 0.9);
    }

    .hero-meta {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .hero-meta h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--text);
      letter-spacing: 0.04em;
    }

    .hero-meta p {
      margin: 0;
      color: var(--muted);
      max-width: 640px;
    }

    .eyebrow {
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.4em;
      color: var(--accent);
    }

    .hero-actions {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .hero-actions button {
      border: 1px solid rgba(126, 247, 199, 0.45);
      color: var(--accent);
      background: transparent;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 600;
    }

    .hero-actions button:hover {
      background: rgba(126, 247, 199, 0.12);
    }

    #terminal {
      width: min(1100px, 92%);
      margin: 12px auto 42px;
      min-height: 480px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(126, 247, 199, 0.35);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      position: relative;
    }

    #terminal.terminal {
      --background: rgba(3, 7, 12, 0.96);
      --color: var(--text);
      --link-color: var(--accent-strong);
      --font: 'Source Code Pro', monospace;
      height: 100%;
    }

    #terminal.terminal::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: url('rust-db.png');
      background-size: 420px;
      background-repeat: no-repeat;
      background-position: 70% 20%;
      opacity: 0.03;
      pointer-events: none;
      transform: rotate(-18deg);
    }

    #terminal .terminal-wrapper {
      backdrop-filter: blur(5px);
    }

    @media (max-width: 720px) {
      .hero-card {
        flex-direction: column;
        text-align: center;
      }

      .hero-card img {
        width: 72px;
        height: 72px;
      }

      .hero-meta p {
        text-align: center;
      }

      .hero-actions {
        justify-content: center;
      }

      #terminal {
        min-height: 60vh;
      }
    }
  </style>
</head>

<body>
  <div class="hero">
    <div class="hero-card">
      <img src="rust-db.png" alt="QuillSQL">
      <div class="hero-meta">
        <span class="eyebrow">QuillSQL</span>
        <h1>QuillSQL Web Shell</h1>
        <p>An educational Rust RDBMS with MVCC, B+Tree, WAL, and CMU 15-445 style ergonomics. This
          browser shell talks directly to the QuillSQL server HTTP API.</p>
        <div class="hero-actions">
          <button data-link="https://feichai0017.github.io/QuillSQL/">Docs</button>
          <button data-link="https://github.com/feichai0017/QuillSQL">GitHub</button>
          <button data-link="https://github.com/feichai0017">Profile</button>
        </div>
      </div>
    </div>
  </div>
  <div id="terminal"></div>

  <script>
    const STORAGE_KEY = 'quillsql:apiBase';
    const DEFAULT_ENDPOINT = '/api/sql';
    const DOCS_URL = 'https://feichai0017.github.io/QuillSQL/';
    const GITHUB_URL = 'https://github.com/feichai0017/QuillSQL';
    const PROFILE_URL = 'https://github.com/feichai0017';
    const META_COMMANDS = new Set(['help', 'docs', 'github', 'profile', 'endpoint', 'history', 'clear']);

    const ASCII_LOGO = String.raw`
      '   ██████╗ ██╗   ██╗██╗██╗     ██╗     ███████╗ ██████╗ ██╗      ',
      '  ██╔═══██╗██║   ██║██║██║     ██║     ██╔════╝██╔═══██╗██║      ',
      '  ██║   ██║██║   ██║██║██║     ██║     ███████╗██║   ██║██║      ',
      '  ██║▄▄ ██║██║   ██║██║██║     ██║     ╚════██║██║▄▄ ██║██║      ',
      '  ╚██████╔╝╚██████╔╝██║███████╗███████╗███████║╚██████╔╝███████╗ ',
      '   ╚══▀▀═╝  ╚═════╝ ╚═╝╚══════╝╚══════╝╚══════╝ ╚══▀▀═╝ ╚══════╝ ',
      '-----------------------------------------------------------------',
      '    QuillSQL • Interactive Terminal • `help` for usage           '
`;

    const HELP_TEXT = [
      '[[b;;]Commands]',
      '  \\help               Show this message',
      '  \\docs               Open the QuillSQL Book in a new tab',
      '  \\github             Open the repository',
      '  \\profile            Maintainer profile',
      '  \\endpoint           Show current SQL endpoint',
      '  \\endpoint <value>   Override SQL endpoint (use `default` to reset)',
      '  \\history            Print submitted SQL blocks',
      '  \\clear              Clear the terminal',
      '',
      'End SQL statements with a semicolon. Paste multi-line scripts and the shell will split them automatically.'
    ].join('\n');

    const commandHistory = [];
    let pendingSql = '';

    const getEndpoint = () => localStorage.getItem(STORAGE_KEY) || DEFAULT_ENDPOINT;
    const setEndpoint = (value) => localStorage.setItem(STORAGE_KEY, value);

    function splitStatements(sqlText) {
      return sqlText
        .split(';')
        .map((s) => s.trim())
        .filter(Boolean)
        .map((s) => `${s};`);
    }

    function formatRows(rows) {
      if (!rows || rows.length === 0) {
        return '✓ OK (0 rows)';
      }
      const widths = [];
      rows.forEach((row) =>
        row.forEach((cell, idx) => {
          const len = String(cell ?? '').length;
          widths[idx] = Math.max(widths[idx] || 0, len);
        }),
      );
      return rows
        .map((row) =>
          row
            .map((cell, idx) => String(cell ?? '').padEnd(widths[idx]))
            .join(' | ')
        )
        .join('\n');
    }

    async function executeStatement(sql) {
      const response = await fetch(getEndpoint(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sql }),
      });
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(errText || `HTTP ${response.status}`);
      }
      const data = await response.json();
      return Array.isArray(data.rows) ? data.rows : [];
    }

    async function runSQL(block, term) {
      const statements = splitStatements(block);
      if (!statements.length) {
        term.echo('[[;#7ea1b8;]No executable SQL detected.]');
        return;
      }
      commandHistory.push(block.trim());
      term.echo(`[[;${'#7ef7c7'};]Running ${statements.length} statement(s) against ${getEndpoint()}]`);
      term.pause();
      try {
        for (let i = 0; i < statements.length; i += 1) {
          const stmt = statements[i];
          term.echo(`[[b;;]#${i + 1}] ${stmt.trim()}`);
          const rows = await executeStatement(stmt);
          term.echo(formatRows(rows));
          term.echo('');
        }
      } catch (err) {
        term.echo(`[[;#ff7b72;]${err.message}]`);
      } finally {
        term.resume();
      }
    }

    function openLink(url) {
      const win = window.open(url, '_blank', 'noopener');
      if (!win) {
        alert(`Please open ${url} manually (popup blocked).`);
      }
    }

    function showHistory(term) {
      if (!commandHistory.length) {
        term.echo('[[;#7ea1b8;]History is empty.]');
        return;
      }
      commandHistory.forEach((cmd, idx) => {
        term.echo(`${String(idx + 1).padStart(2, '0')}: ${cmd}`);
      });
    }

    function handleMetaCommand(input, term) {
      const trimmed = input.startsWith('\\') ? input.slice(1) : input;
      const [cmd, ...rest] = trimmed.trim().split(/\s+/);
      const args = rest.join(' ').trim();

      switch ((cmd || '').toLowerCase()) {
        case 'help':
          term.echo(HELP_TEXT);
          break;
        case 'docs':
          openLink(DOCS_URL);
          term.echo(`Opened docs: ${DOCS_URL}`);
          break;
        case 'github':
          openLink(GITHUB_URL);
          term.echo(`Opened repository: ${GITHUB_URL}`);
          break;
        case 'profile':
          openLink(PROFILE_URL);
          term.echo(`Opened maintainer profile: ${PROFILE_URL}`);
          break;
        case 'endpoint':
          if (!args) {
            term.echo(`Current SQL endpoint: ${getEndpoint()}`);
          } else if (args === 'default' || args === 'reset') {
            setEndpoint(DEFAULT_ENDPOINT);
            term.echo(`Endpoint reset to ${DEFAULT_ENDPOINT}`);
          } else {
            setEndpoint(args);
            term.echo(`Endpoint set to ${args}`);
          }
          break;
        case 'history':
          showHistory(term);
          break;
        case 'clear':
          term.clear();
          term.echo(greeting());
          break;
        default:
          term.echo(`[[;#ff7b72;]Unknown command: ${cmd}]`);
      }
    }

    function parseMeta(input) {
      if (!input) return null;
      if (input.trim().startsWith('\\')) {
        return input;
      }
      const keyword = input.trim().split(/\s+/)[0]?.toLowerCase();
      if (META_COMMANDS.has(keyword)) {
        return input;
      }
      return null;
    }

    function greeting() {
      return `${ASCII_LOGO}
[[b;;]QuillSQL Web Shell]
Type [[b;;]\\help] for commands. Statements run through the HTTP API exposed by \`cargo run --bin server\`.
`;
    }

    $(document).ready(() => {
      document.querySelectorAll('[data-link]').forEach((btn) => {
        btn.addEventListener('click', (event) => {
          const url = event.currentTarget.getAttribute('data-link');
          openLink(url);
        });
      });

      const term = $('#terminal').terminal(async (command) => {
        const meta = parseMeta(command);
        if (meta) {
          pendingSql = '';
          handleMetaCommand(meta, term);
          term.set_prompt(promptText());
          return;
        }

        pendingSql = pendingSql ? `${pendingSql}\n${command}` : command;
        if (/;\s*$/.test(pendingSql.trim())) {
          const block = pendingSql;
          pendingSql = '';
          term.set_prompt(promptText());
          await runSQL(block, term);
        } else if (!pendingSql.trim()) {
          pendingSql = '';
          term.set_prompt(promptText());
        } else {
          term.set_prompt(promptText(true));
        }
      }, {
        greetings: greeting(),
        name: 'quillsql-shell',
        prompt: () => promptText(),
      });

      function promptText(continuation) {
        return continuation || pendingSql ? '[[b;;]... ]' : '[[b;;]quillsql> ]';
      }
    });
  </script>
</body>

</html>
